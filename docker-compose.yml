version: '3.8'

services:
  fix-perms:
    image: debian:bookworm-slim
    container_name: snek2-fix-perms
    user: "0:0"
    working_dir: /workspace
    volumes:
      - ./:/workspace
    entrypoint: ["/bin/sh", "-lc"]
    command: >
      "set -e; \
       echo 'Fixing ownership under /workspace (UID=${UID:-1000} GID=${GID:-1000})'; \
       chown -R ${UID:-1000}:${GID:-1000} /workspace/data /workspace/models /workspace/scraper-data || true; \
       echo 'Done.'"

  scraper:
    build:
      context: .
      dockerfile: scraper/Dockerfile
    container_name: battlesnake-scraper
    restart: unless-stopped
    user: "${UID:-1000}:${GID:-1000}"
    environment:
      WRITTEN_LOG: /data/written_games.log
      OUT_DIR: /output
      DELAY: 500ms
    volumes:
      # Written-log persistence
      - ${SCRAPER_STATE_DIR:-./scraper-data}:/data
      # Training data output (set SCRAPER_OUT_DIR to control host destination)
      - ${SCRAPER_OUT_DIR:-./data/scraped}:/output

  orchestrator:
    # Requires Docker Desktop/engine with NVIDIA runtime support.
    gpus: all
    build:
      context: .
      dockerfile: infrastructure/pipeline/Dockerfile
    container_name: snek2-orchestrator
    restart: unless-stopped
    user: "${UID:-1000}:${GID:-1000}"
    depends_on:
      - scraper
    working_dir: /workspace
    environment:
      # Where selfplay and scraper write parquet shards.
      GENERATED_DIR: data/generated
      SCRAPED_DIR: data/scraped
      PROCESSED_DIR: processed
      MODEL_DIR: models
      HISTORY_DIR: models/history

      # Selfplay (generation)
      GENERATE_GAMES: ${GENERATE_GAMES:-128}
      WORKERS: ${WORKERS:-128}
      GAMES_PER_FLUSH: ${GAMES_PER_FLUSH:-64}
      ONNX_SESSIONS: ${ONNX_SESSIONS:-1}
      ONNX_BATCH_SIZE: ${ONNX_BATCH_SIZE:-0}
      ONNX_BATCH_TIMEOUT: ${ONNX_BATCH_TIMEOUT:-2ms}

      # ORT: default to CPU inside Docker unless you provide CUDA libs.
      SNEK2_ORT_DISABLE_CUDA: ${SNEK2_ORT_DISABLE_CUDA:-0}

      # Training
      TRAIN_EPOCHS: ${TRAIN_EPOCHS:-10}
      TRAIN_BATCH_SIZE: ${TRAIN_BATCH_SIZE:-256}
      TRAIN_LR: ${TRAIN_LR:-0.01}

      SLEEP_BETWEEN_CYCLES: ${SLEEP_BETWEEN_CYCLES:-0}
      MIN_FILE_AGE_SECONDS: ${MIN_FILE_AGE_SECONDS:-0}
      ARCHIVE_EXISTING_ON_START: ${ARCHIVE_EXISTING_ON_START:-1}
    volumes:
      - ./:/workspace