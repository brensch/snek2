version: '3.8'

services:
  scraper:
    build:
      context: .
      dockerfile: scraper/Dockerfile
    container_name: battlesnake-scraper
    restart: unless-stopped
    user: "${SNEK2_UID:?Set SNEK2_UID}:${SNEK2_GID:?Set SNEK2_GID}"
    environment:
      WRITTEN_LOG: /data/written_games.log
      OUT_DIR: /output
      DELAY: 500ms
    volumes:
      # Written-log persistence
      - ${SCRAPER_STATE_DIR:-./scraper-data}:/data
      # Training data output (set SCRAPER_OUT_DIR to control host destination)
      - ${SCRAPER_OUT_DIR:-./data/scraped}:/output

  orchestrator:
    # Requires Docker Desktop/engine with NVIDIA runtime support.
    gpus: all
    build:
      context: .
      dockerfile: infrastructure/pipeline/Dockerfile
    container_name: snek2-orchestrator
    restart: unless-stopped
    user: "${SNEK2_UID:?Set SNEK2_UID}:${SNEK2_GID:?Set SNEK2_GID}"
    depends_on:
      - scraper
    working_dir: /workspace
    environment:
      # Where selfplay and scraper write parquet shards.
      GENERATED_DIR: data/generated
      SCRAPED_DIR: data/scraped
      PROCESSED_DIR: processed
      MODEL_DIR: models
      HISTORY_DIR: models/history

      # Selfplay (generation)
      # Match Makefile defaults as closely as possible.
      # (Makefile: WORKERS=512, GAMES_PER_FLUSH=50, MAX_GAMES=0, TRACE=true)
      GENERATE_GAMES: ${GENERATE_GAMES:-256}
      WORKERS: ${WORKERS:-512}
      GAMES_PER_FLUSH: ${GAMES_PER_FLUSH:-50}
      ONNX_SESSIONS: ${ONNX_SESSIONS:-1}
      ONNX_BATCH_SIZE: ${ONNX_BATCH_SIZE:-512}
      ONNX_BATCH_TIMEOUT: ${ONNX_BATCH_TIMEOUT:-5ms}
      TRACE: ${TRACE:-true}

      # ORT: default to CPU inside Docker unless you provide CUDA libs.
      SNEK2_ORT_DISABLE_CUDA: ${SNEK2_ORT_DISABLE_CUDA:-0}

      # Training
      TRAIN_EPOCHS: ${TRAIN_EPOCHS:-10}
      TRAIN_BATCH_SIZE: ${TRAIN_BATCH_SIZE:-256}
      TRAIN_LR: ${TRAIN_LR:-0.001}

      SLEEP_BETWEEN_CYCLES: ${SLEEP_BETWEEN_CYCLES:-0}
      MIN_FILE_AGE_SECONDS: ${MIN_FILE_AGE_SECONDS:-0}
      ARCHIVE_EXISTING_ON_START: ${ARCHIVE_EXISTING_ON_START:-1}
    volumes:
      - ./:/workspace